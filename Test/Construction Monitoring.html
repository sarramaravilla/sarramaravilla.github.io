<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Construction Monitoring</title>
  <style>
    html,
    body,
    #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }

    #headerTitleDiv {
      font-size: 2.5vw;
      vertical-align: middle;
      padding-top: 3px;
      z-index: 99;
      position: absolute;
      left: 13;
      top: 18;
      color: white;
    }

    #chartPanelDiv {
      font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
      z-index: 99;
      position: absolute;
      left: 0;
      margin-top: 14%;
      bottom: 80;
    }

    #chartdiv {
      width: 20vw;
      height: 37vh;
      align-items: center;
      font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
      padding: 0;
      margin: 0;
    }


    .panel {
      padding: 0px;
      margin: 0;
      box-sizing: border-box;
      width: 15vw;
      height: 40vh;
      position: absolute;
      top: 10%;
      right: 1;
      font-size: 1.3vw;
      color: white;
      background-color: rgb(0, 0, 0, 0);
      z-index: 99;
      transition: 3;
      line-height: 2;
    }


    ;
  </style>

  <link rel="stylesheet" href="https://js.arcgis.com/4.24/esri/themes/light/main.css" />

  <script src="https://js.arcgis.com/4.24/"></script>
  <script src="https://cdn.amcharts.com/lib/4/core.js"></script>
  <script src="https://cdn.amcharts.com/lib/4/charts.js"></script>
  <script src="https://www.amcharts.com/lib/4/themes/dark.js"></script>
  <script src="https://cdn.amcharts.com/lib/4/themes/animated.js"></script>

  <script>
    require([
      "esri/Basemap",
      "esri/Map",
      "esri/views/MapView",
      "esri/views/SceneView",
      "esri/layers/FeatureLayer",
      "esri/views/layers/support/FeatureFilter",
      "esri/layers/SceneLayer",
      "esri/layers/Layer",
      "esri/layers/TileLayer",
      "esri/layers/VectorTileLayer",
      "esri/layers/support/LabelClass",
      "esri/symbols/LabelSymbol3D",
      "esri/WebMap",
      "esri/WebScene",
      "esri/portal/PortalItem",
      "esri/portal/Portal",
      "esri/widgets/TimeSlider",
      "esri/widgets/Legend",
      "esri/widgets/LayerList",
      "esri/widgets/Fullscreen",
      "esri/rest/geometryService",
      "esri/rest/support/Query",
      "esri/rest/support/StatisticDefinition",
      "esri/symbols/WebStyleSymbol",
      "esri/TimeExtent",
      "esri/widgets/Expand",
      "esri/widgets/Editor",
      "esri/renderers/UniqueValueRenderer",
      "esri/widgets/support/DatePicker",
      "esri/widgets/FeatureTable",
      "esri/widgets/Compass",
      "esri/layers/ElevationLayer",
      "esri/Ground",
      "esri/layers/BuildingSceneLayer",
      "esri/widgets/BuildingExplorer",
      "esri/widgets/Slice",
      "esri/analysis/SlicePlane",
      "esri/renderers/SimpleRenderer",
      "esri/symbols/MeshSymbol3D",
      "esri/symbols/edges/SolidEdges3D",
      "esri/layers/GroupLayer",
      "esri/widgets/BasemapToggle",
      "esri/widgets/Daylight"],
      function (Basemap, Map, MapView, SceneView,
        FeatureLayer, FeatureFilter,
        SceneLayer, Layer, TileLayer, VectorTileLayer,
        LabelClass, LabelSymbol3D, WebMap,
        WebScene, PortalItem, Portal,
        TimeSlider, Legend, LayerList, Fullscreen,
        geometryService, Query,
        StatisticDefinition, WebStyleSymbol,
        TimeExtent, Expand, Editor, UniqueValueRenderer, DatePicker,
        FeatureTable, Compass, ElevationLayer, Ground,
        BuildingSceneLayer, BuildingExplorer, Slice, SlicePlane,
        SimpleRenderer, MeshSymbol3D, SolidEdges3D, GroupLayer, BasemapToggle, Daylight) {


        // Create Map
        var map = new Map({
          basemap: "dark-gray-vector",
          ground: "world-elevation"
        });

        // Create the SceneView
        var view = new SceneView({
          container: "viewDiv",
          map: map,
          camera: {
            position: [4.479686585031793, 51.9071412859027, 200],
            tilt: 60,

          }
        });
        //end


        //Add Basemap toggle
        const toggle = new BasemapToggle({
          view: view,
          nextBasemap: "hybrid"
        });
        view.ui.add(toggle, "top-right");


        // Create BuildingSceneLayer and add to the map
        var buildingLayer = new BuildingSceneLayer({
          portalItem: {
            id: "3d2c7aad70734b0795fbef357be381e8"
          },
          outFields: ["*"],
          title: "De Zalmhaven Midrise"
        });
        map.add(buildingLayer);


        //Discipline: Architectural
        var columnsLayer = null;
        var slabsLayer = null;
        var wallsLayer = null;

        //Discipline: Structural
        var beamsLayer = null;
        var stFoundationLayer = null;

        buildingLayer.when(() => {
          buildingLayer.allSublayers.forEach((layer) => {
            switch (layer.modelName) {
              case "FullModel":
                layer.visible = true;
                break;

              //case "GenericModel":
              //case "OpeningElement":
              //layer.visible = false;
              //break;

              case "Columns":
                columnsLayer = layer;
                break;

              case "Slabs":
                slabsLayer = layer;
                break;

              case "Walls":
                wallsLayer = layer;
                break;

              case "Beams":
                beamsLayer = layer;
                break;

              case "StructuralFoundation":
                stFoundationLayer = layer;
                break;

              default:
                layer.visible = true;
            }
          });
        });
        //end


        //Remove deafult widgets on the left
        view.ui.empty("top-left");
        //end

        //Adding building explorer
        const buildingExplorer = new BuildingExplorer({
          view: view,
          layers: [buildingLayer]
        });
        view.ui.add(buildingExplorer, "bottom-right");

        // only display the building levels filter
        buildingExplorer.visibleElements = {
          phases: false,
          disciplines: true
        };
        //end



        // Adding OpenStreetMap 3D Buildings
        // Defining the osm 3D building symbol
        let osmSymbol = {
          type: "mesh-3d",
          symbolLayers: [
            {
              type: "fill",
              material: {
                color: [74, 80, 87, 0.5],
                colorMixMode: "replace"
              },
              edges: {
                type: "solid", // autocasts as new SolidEdges3D()
                color: [225, 225, 225, 0.3]
              }
            }
          ]
        };

        //Add the Open Street map with symbol "osmSymbol"
        var osm3D = new SceneLayer({
          portalItem: {
            id: "ca0470dbbddb4db28bad74ed39949e25"
          },
          title: "OpenStreetMap 3D Buildings"
        });
        map.add(osm3D);
        osm3D.renderer = {
          type: "simple",
          symbol: osmSymbol
        }
        //end


        //Add the 3D cities rotterdam
        var city3D = new SceneLayer({
          portalItem: {
            id: "84c714b47e9140d4afb4a52d46027523"
          },
          title: "Esri Netherlands Textured 3D Buildings"
        });
        map.add(city3D)
        //end

        

        /// chart
        const headerTitleDiv = document.getElementById("headerTitleDiv");

        /***************************
         * Creating charts
         ***************************/

        am4core.ready(() => {
          am4core.useTheme(am4themes_animated);

          const compArray = {
            1: [], 2: [], 3: [], 4: [],
            5: [], 6: [], 7: [], 8: [],
            9: [], 10: [], 11: [], 12: []
          };


          function columns() {
            var total_columns_tobeC = {
              onStatisticField: "CASE WHEN Status = 1 THEN 1 ELSE 0 END",
              outStatisticFieldName: "total_columns_tobeC",
              statisticType: "sum"
            };
            var total_columns_underC = {
              onStatisticField: "CASE WHEN Status = 2 THEN 1 ELSE 0 END",
              outStatisticFieldName: "total_columns_underC",
              statisticType: "sum"
            };
            var total_columns_done = {
              onStatisticField: "CASE WHEN Status = 4 THEN 1 ELSE 0 END",
              outStatisticFieldName: "total_columns_done",
              statisticType: "sum"
            };
            var total_columns_delayed = {
              onStatisticField: "CASE WHEN Status = 3 THEN 1 ELSE 0 END",
              outStatisticFieldName: "total_columns_delayed",
              statisticType: "sum"
            };

            var query = columnsLayer.createQuery();
            query.outStatistics = [total_columns_tobeC, total_columns_underC, total_columns_done, total_columns_delayed];
            query.returnGeometry = true;

            return columnsLayer.queryFeatures(query).then(function (response) {
              var stats = response.features[0].attributes;

              // columns
              const columns_tobeC = stats.total_columns_tobeC;
              const columns_underC = stats.total_columns_underC;
              const columns_done = stats.total_columns_done;
              const columns_delayed = stats.total_columns_delayed;
              const compile_columns = [columns_done, columns_underC, columns_tobeC, columns_delayed];

              for (var i = 0; i <= 3; i++) {
                compArray[i + 1] = compile_columns[i];
              }
              return compArray;
            });
          } //end of columns function


          function slabs() {
            var total_slabs_tobeC = {
              onStatisticField: "CASE WHEN Status = 1 THEN 1 ELSE 0 END",
              outStatisticFieldName: "total_slabs_tobeC",
              statisticType: "sum"
            };
            var total_slabs_underC = {
              onStatisticField: "CASE WHEN Status = 2 THEN 1 ELSE 0 END",
              outStatisticFieldName: "total_slabs_underC",
              statisticType: "sum"
            };
            var total_slabs_done = {
              onStatisticField: "CASE WHEN Status = 4 THEN 1 ELSE 0 END",
              outStatisticFieldName: "total_slabs_done",
              statisticType: "sum"
            };
            var total_slabs_delayed = {
              onStatisticField: "CASE WHEN Status = 3 THEN 1 ELSE 0 END",
              outStatisticFieldName: "total_slabs_delayed",
              statisticType: "sum"
            };

            var query = slabsLayer.createQuery();
            query.outStatistics = [total_slabs_tobeC, total_slabs_underC, total_slabs_done, total_slabs_delayed];
            query.returnGeometry = true;

            return slabsLayer.queryFeatures(query).then(function (response) {
              var stats = response.features[0].attributes;

              // slabs
              const slabs_tobeC = stats.total_slabs_tobeC;
              const slabs_underC = stats.total_slabs_underC;
              const slabs_done = stats.total_slabs_done;
              const slabs_delayed = stats.total_slabs_delayed;
              const compile_slabs = [slabs_done, slabs_underC, slabs_tobeC, slabs_delayed];

              for (var i = 0; i <= 3; i++) {
                compArray[i + 5] = compile_slabs[i];
              }
              return compArray;
            });
          } //end of slabs function


          function walls() {
            var total_walls_tobeC = {
              onStatisticField: "CASE WHEN Status = 1 THEN 1 ELSE 0 END",
              outStatisticFieldName: "total_walls_tobeC",
              statisticType: "sum"
            };
            var total_walls_underC = {
              onStatisticField: "CASE WHEN Status = 2 THEN 1 ELSE 0 END",
              outStatisticFieldName: "total_walls_underC",
              statisticType: "sum"
            };
            var total_walls_done = {
              onStatisticField: "CASE WHEN Status = 4 THEN 1 ELSE 0 END",
              outStatisticFieldName: "total_walls_done",
              statisticType: "sum"
            };
            var total_walls_delayed = {
              onStatisticField: "CASE WHEN Status = 3 THEN 1 ELSE 0 END",
              outStatisticFieldName: "total_walls_delayed",
              statisticType: "sum"
            };

            var query = wallssLayer.createQuery();
            query.outStatistics = [total_walls_tobeC, total_walls_underC, total_walls_done, total_walls_delayed];
            query.returnGeometry = true;

            return wallsLayer.queryFeatures(query).then(function (response) {
              var stats = response.features[0].attributes;

              // walls
              const walls_tobeC = stats.total_walls_tobeC;
              const walls_underC = stats.total_walls_underC;
              const walls_done = stats.total_walls_done;
              const walls_delayed = stats.total_walls_delayed;
              const compile_walls = [walls_done, walls_underC, walls_tobeC, walls_delayed];

              for (var i = 0; i <= 3; i++) {
                compArray[i + 9] = compile_walls[i];
              }
              return compArray;
            });
          } //end of walls function

          function updateArchi(compArray) {
            //CHART//
            var chart = am4core.create("chartdiv", arm4charts.XYChart);
            chart.hiddenState.properties.opacity = 0;

            chart.data = [
              {
                category: "Columns",
                value1: compArray[1],
                value2: compArray[2],
                value3: compArray[3],
                value4: compArray[4]
              },
              {
                category: "Slabs",
                value1: compArray[5],
                value2: compArray[6],
                value3: compArray[7],
                value4: compArray[8]
              },
              {
                category: "Walls",
                value1: compArray[9],
                value2: compArray[10],
                value3: compArray[11],
                value4: compArray[12]
              }
            ]; //End of Chart


            chart.colors.step = 2;
            chart.padding(10, 10, 10, 10);

            // Legend
            const LegendFontSizze = 15;
            chart.legend = new am4charts.Legend();

            chart.legend.valueLabels.template.align = "right"
            chart.legend.valueLabels.template.textAlign = "end";

            chart.legend.position = "bottom";
            chart.legend.labels.template.fontSize = LegendFontSizze;
            chart.legend.labels.template.fill = "#ffffff";
            chart.legend.valueLabels.template.fill = am4core.color("#ffffff");
            chart.legend.valueLabels.template.fontSize = LegendFontSizze;
            chart.legend.disabled = true;

            var marker = chart.legend.markers.template.children.getIndex(0);
            var markerTemplate = chart.legend.markers.template;
            marker.cornerRadius(12, 12, 12, 12);
            marker.strokeWidth = 1;
            marker.strokeOpacity = 1;
            marker.stroke = am4core.color("#ccc");

            // Change size of legend marker
            markerTemplate.width = 16;
            markerTemplate.height = 16;

            var categoryAxis = chart.yAxes.push(new am4charts.CategoryAxis());
            categoryAxis.dataFields.category = "category";
            categoryAxis.renderer.grid.template.location = 0;
            categoryAxis.renderer.labels.template.fontSize = 16;
            categoryAxis.renderer.labels.template.fill = "#ffffff";
            categoryAxis.renderer.minGridDistance = 5; //can change label

            var valueAxis = chart.xAxes.push(new am4charts.ValueAxis());
            valueAxis.min = 0;
            valueAxis.max = 100;
            valueAxis.strictMinMax = true;
            valueAxis.calculateTotals = true;
            valueAxis.renderer.minWidth = 50;
            valueAxis.renderer.labels.template.fontSize = 14;
            valueAxis.renderer.labels.template.fill = "#ffffff";

            function createSeries(field, name) {
              var series = chart.series.push(new am4charts.ColumnSeries());
              series.calculatePercen = true;
              series.dataFields.valueX = field;
              series.dataFields.categoryY = "category";
              series.stacked = true;
              series.dataFields.valueXShow = "totalPercent";
              series.dataItems.template.locations.categoryY = 0.5;
              // Bar chart line color and width
              series.columns.template.stroke = am4core.color("#ffffff");
              series.columns.template.strokeWidth = 0.5;
              series.name = name;

              var labelBullet = series.bullets.push(new am4charts.LabelBullet());

              if (name == "To be Constructed") {
                series.fill = am4core.color("#000000");
                series.fillOpacity = 0.7;
                labelBullet.locationX = 0.7;

                labelBullet.locationX = 0.5;
                labelBullet.label.text = "";

                //labelBullet.label.fill = am4core.color("#00FFFFFF");
                labelBullet.label.fill = am4core.color("#000000");
                labelBullet.interactionsEnabled = false;
                labelBullet.label.fontSize = 13;
                labelBullet.locationX = 0.5;

              } else if (name == "Under Construction") {
                series.fill = am4core.color("#c2c2c2");
                series.fillOpacity = 0.7;
                labelBullet.locationX = 0.7;
                labelBullet.locationX = 0.5;
                labelBullet.label.text = "{valueX.totalPercent.formatNumber('#.')}%";
                labelBullet.label.fill = am4core.color("#ffffff");
                labelBullet.interactionsEnabled = false;
                labelBullet.label.fontSize = 0;
                labelBullet.locationX = 0.5;

              } else if (name == "Completed") {
                series.fill = am4core.color("#0070ff");
                series.fillOpacity = 0.7;
                labelBullet.locationX = 0.7;
                labelBullet.label.text = "{valueX.totalPercent.formatNumber('#.')}%";
                labelBullet.label.fill = am4core.color("#ffffff");
                labelBullet.interactionsEnabled = false;
                labelBullet.label.fontSize = 20;
                labelBullet.locationX = 0.5;

              } else {
                series.fill = am4core.color("#ff0000"); // delayed
                series.fillOpacity = 0.7;
                labelBullet.locationX = 0.7;
                labelBullet.locationX = 0.5;
                labelBullet.label.text = "{valueX.totalPercent.formatNumber('#.')}%";
                labelBullet.label.fill = am4core.color("#ffffff");
                labelBullet.interactionsEnabled = false;
                labelBullet.label.fontSize = 0;
                labelBullet.locationX = 0.5;

              }
              series.columns.template.width = am4core.percent(60);
              series.columns.template.tooltipText = "[font-size:12px]{name}: {valueX.value.formatNumber('#.')}"

              // Click chart and filter, update maps
              //const chartElement = document.getElementById("chartPanel");
              ///////////////////////
              // Click chart and filter, update maps
              const chartPanelDiv = document.getElementById("chartPanelDiv");

              series.columns.template.events.on("hit", filterByChart, this);
              function filterByChart(ev) {
                //const selectedC = ev.target.dataItem.component.name;
                const selectedP = ev.target.dataItem.categoryY;

                // D-walls
                if (selectedP == "Columns") {
                  selectedLayer = "Columns";
                  columnsLayer.visible = true;
                  slabsLayer.visible = false;
                  wallsLayer.visible = false;

                } else if (selectedP == "Slabs") {
                  selectedLayer = "Slabs"
                  columnsLayer.visible = false;
                  slabsLayer.visible = true;
                  wallsLayer.visible = false;

                } else if (selectedP == "Walls") {
                  selectedLayer = "Walls";
                  columnsLayer.visible = false;
                  slabsLayer.visible = false;
                  wallsLayer.visible = true;

                } else {
                  selectedLayer = null;
                }

                // Listen to the click event on the map view and resets to default 
                view.on("click", function () {
                  columnsLayer.visible = true;
                  slabsLayer.visible = true;
                  wallsLayer.visible = true;
                });
              } // End of filterByChart

              //////////////////////////

            } // End of createSeries function
            createSeries("value1", "Completed");
            createSeries("value2", "Under Construction");
            createSeries("value3", "To be Constructed");
            createSeries("value4", "Delayed");

          } // Update Chart

          function combineAll() {
            columns()
              .then(slabs)
              .then(walls)
              .then(updateArchi);
          }

        });






        /***************************
         * Initialize all widgets
         ***************************/

        //Adding LayerList with OSM 3D building & textured building being off
        var LayerList = new LayerList({
          view: view,
          listItemCreatedFunction: function (event) {
            const item = event.item;
            if (item.title === "OpenStreetMap 3D Buildings" ||
              item.title === "Esri Netherlands Textured 3D Buildings") {
              item.visible = false
            }
          }
        });

        var layerListExpand = new Expand({
          view: view,
          content: LayerList,
          expandIconClass: "esri-icon-visible",
          group: "top-right"
        });

        view.ui.add(layerListExpand, "top-right");
        //end


        //Adding the daylight widget
        const daylight = new Daylight({
          view: view,
          //play the animation twice as fast than the default one
          playSpeedMultiplier: 2,
          //disable the timezone selection button
          visibleElements: {
            timezone: false
          }
        }); view.ui.add(new Expand({ content: daylight, view: view, expanded: false }), "top-right");
        //end

        /*****Add Editor Widget
        view.when(() => {
          view.popup.autoOpenEnabled = true;

          let editor = new Editor ({
          view:view
        });

        view.ui.add(editor, "bottom-right");
        });******/


        //Full Screen Logo
        view.ui.add(
          new Fullscreen({
            view: view,
            element: viewDiv
          }),
          "top-right"
        );//end


      });
  </script>


</head>

<body class="sassy-theme">
  <div id="viewDiv">
    <div id="headerTitleDiv">DE ZALMHAVEN MIDRISE</div>
    <div id="chartPanelDiv">
      <div id="chartdiv"></div>
    </div>
  </div>
</body>

</html>